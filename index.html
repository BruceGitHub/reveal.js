<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>PHP + ES + CQRS + DDD = ? - A planned strategy</title>
    <meta name="description" content="{{ Descrizione }}">
    <meta name="author" content="Alessandro Lai">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/facile-engineering.css" id="theme">
    <link type="image/x-icon" rel="shortcut icon" href="img/favicon.ico"/>

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section id="title" data-background-image="img/theme/bg-cover.svg">
            <h1>PHP + ES + CQRS + DDD = ?</h1>
            <h2>A planned strategy</h2>
            <p>
<!--                <a href="https://alessandrolai.dev/">Alessandro Lai</a> / <a href="http://twitter.com/AlessandroLai">@AlessandroLai</a><br>-->
                <a href="https://gitlab.facile.it/pagamenti">Payments Team</a>
            </p>
            <small>
                <p>
                    <a href="{{ event-link }}">Venerd√¨ protetto</a> - February 18th 2022,
                    Facile.it (online)
                </p>
<!--                <p class="smaller">-->
<!--                    <a href="https://joind.in/talk/TODO-CHANGEME">https://joind.in/talk/TODO-CHANGEME</a>-->
<!--                </p>-->
            </small>
        </section>

        <section id="intro">
            <section>
                <h2>Who are we?</h2>
                (TODO: team slide from Nico)
            </section>
        </section>
        
        <section id="section-base-concepts">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li class="current">Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Event Sourcing</h3>
                <p>[Classic example of money account]</p>
                <p>[Distinction between events and projections, cite aggregates]</p>
                <p>[Stress the point of immutable, append only event store]</p>
                <aside class="notes">
                    Qui possiamo avere note per lo speaker
                </aside>
            </section>
            <section>
                <h3>CQRS</h3>
                <ul>
                    <li>Command</li>
                    <li>Query</li>
                    <li>Responsibility</li>
                    <li>Segregation</li>
                </ul>
                <p>[Events are write, projections/aggregates are read]</p>
            </section>
            <section>
                <h3>Domain Driven Design</h3>
                <p>[Tactical patterns: VO, entities, aggregates]</p>
                <p>[Strategic DDD: from aggregates to bounded contexts]</p>
            </section>
            <section>
                <h3>Bonus: Event Storming</h3>
                <p>[cite Brandolini]</p>
            </section>
            <section>
                <img src="img/dreamteam_assemble.jpg" class="stretch" />
            </section>
            <section>
                <h3>All these together</h3>
                <p>[cite Avanscoperta workshop]</p>
            </section>
        </section>
        
        <section id="section-starting-point">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li class="current">Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Pagamenti 2</h3>
                <p>[project born and motivations]</p>
            </section>
            <section>
                <h3>Aggregate & entities involved</h3>
                <p>[graph with product -> orders -> payment reservations]</p>
            </section>
            <section>
                <h3>Decommissioning Sisal from api.facile.it</h3>
                <p>[explain opportunity of limited area of intervention]</p>
            </section>
        </section>
        
        <section id="section-tools">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li class="current">The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>OpenAPI</h3>
                <p>[optional: talk about defining the API with a spec]</p>
            </section>
            <section>
                <h3>The DDD "onion"</h3>
                <p>[domain - infra - app layers diagram]
            </section>
            <section>
                <h3>PHP AT to enforce the "onion"</h3>
                <p>[show code of PHP AT that enforces the 3 layers]</p>
            </section>
            <section>
                <h3>EventSauce</h3>
                <p>[brief library presentation]</p>
            </section>
            <section>
                <h3>EventSauce</h3>
                <pre class="stretch"><code>
                    public function foo(Foo $bar): void 
                    {
                    }
                </code></pre>
            </section>
            <section>
                <h3>Last but not least: Symfony Messenger</h3>
                <p>[brief citation]</p>
            </section>
        </section>
        
        <section id="section-migration-strategy">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li class="current">Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Green field vs running project</h3>
                All this is great for a new project...<br>
                ...but what can we do in a running project?
                <img src="img/changing_wheels.webp" class="fragment" />
            </section>
            <section>
                <h3>Root-first or Leaf first?</h3>
                <div class="stretch graph">
                    <span class="fragment" data-fragment-index="2">Product (root)</span>
                    <div class="fragment" data-fragment-index="3">
                        <i class="fas fa-angle-down"></i> 1..n
                        <span>Orders</span>
                        <i class="fas fa-angle-down"></i> 0..n
                        <span>Payment reservations</span>
                        <i class="fas fa-angle-down"></i> 0..1
                    </div>
                    <span class="fragment" data-fragment-index="1">Mooney codes</span>
                </div>
                <aside class="notes">
                    <ol>
                        <li>incomplete event picture</li>
                        <li>leaf first: no aggregate root id</li>
                        <li>root first: hole in the middle</li>
                    </ol>
                </aside>
            </section>
            <section>
                <h3>The breakthrough</h3>
                <img src="img/multiple-sources-of-lies.jpeg" class="stretch" />
                <br>
                <small>
                    "You have a single source of truth,
                    or multiple sources of lies"
                </small>
            </section>
            <section>
                <h3>The second golden nugget</h3>
                <ul>
                    <li class="fragment">Migrating will take a LONG time</li>
                    <li class="fragment">Sync between legacy and event store</li>
                    <li class="fragment">DB transactions to save data atomically</li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>Migrating will take a LONG time</li>
                        <li>Sync between legacy and event store</li>
                        <li>DB transactions to save data atomically</li>
                    </ul>
                </aside>
            </section>
            <section>
                <h3>Generating events on-the-fly</h3>
                <pre class="php stretch">
<code>class ProductRepository 
    extends EventSourcedAggregateRootRepository 
    implements ProductRepositoryInterface
{
    public function retrieve(AggregateRootId $id): object
    {
        $product = parent::retrieve($id);

        if ($product === null) {
            $legacyProduct = $this->legacyRepository->find($id);

            $product = Product::reconstituteFromEvents(
                $this->eventGenerator->generateFrom($legacyProduct)
            );
        }

        return $product;
    }
}</code></pre>
            </section>
            <section>
                <h3>Maintain the legacy tables</h3>
                <pre class="stretch">
<code>final class Prodotto implements AggregateRoot
{
    // ...

    public function reservePayment(ReservePayment $command): void
    {
        if (/* ... */) {
            // domain logic...
        }

        $event = new MooneyCodeCreated(/* ... */);

        // add the event to the aggregate
        $this->recordThat($event);

        // register the same stuff in the legacy entity
        $this->getLegacyProduct()->addNewCode($event)
    }

    // ...
}</code></pre>
            </section>
            <section>
                <h3>Maintain the legacy tables</h3>
                <pre class="stretch">
<code>class ReservePaymentHandler implements MessageHandlerInterface
{
    public function __invoke(ReservePayment $command): void
    {
        $id = $command->getRootId();
        // retrieve both the aggregate and the legacy entity
        $product = $this->productRepository->retrieve($id);
        $legacyProduct = $product->getLegacyProduct(
            $this->legacyRepository
        );
        // invoke the domain logic
        $product->reservePayment($command);

        // atomic flush due to single DB connection
        $this->legacyRepository->beginTransaction();

        $this->productRepository->persist($product);
        $this->legacyRepository->flush();

        $this->legacyRepository->commit();
    }
}</code></pre>
            </section>
            <section>
                <h3>How to iterate</h3>
                <pre class="php stretch">
<code>class ProductRepository 
    extends EventSourcedAggregateRootRepository 
    implements ProductRepositoryInterface
{
    public function retrieve(AggregateRootId $id): object
    {
        $product = parent::retrieve($id);
    
        if ($this->eventsAreOutdated($product)) {
            $this->purgeEvents($id);
            $product = null;
        }

        if ($product === null) {
            // ...
        }

        return $product;
    }
    // ...
}</code></pre>
            </section>
        </section>

        <section id="section-conclusions">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li class="current">Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Advantages</h3>
                <ul class="fa-ul">
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-shipping-fast"></i></span>
                        Fast iterations
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-user-ninja"></i></span>
                        Gain confidence iteratively
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-cogs"></i></span>
                        Leverage ES & DDD immediately
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-database"></i></span>
                        Legacy still works
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-hourglass-half"></i></span>
                        No fixed deadlines
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-user-tie"></i></span>
                        Still deliver business value
                    </li>
                </ul>
            </section>
            <section>
                <h3>Disadvantages / pitfalls</h3>
                <ol>
                    <li>It may take a long time</li>
                    <li class="fragment">...can you tell us more?</li>
                </ol>
                <br>
                <br>
                <br>
                <h1 class="fragment">Questions?</h1>
            </section>
            <section>
                <h2>Thanks!</h2>
<!--                <p>-->
<!--                    Please rate my talk on Joind.in: <a href="https://joind.in/talk/TODO-CHANGEME">https://joind.in/talk/TODO-CHANGEME</a>-->
<!--                </p>-->
<!--                <img class="stretch" src="img/joindin-qr.png" alt="Joind.in link: https://joind.in/talk/TODO-CHANGEME">-->
            </section>
<!--            <section>-->
<!--                <h2 style="margin-bottom: 2em">Questions?</h2>-->
<!--                <h4>Contacts</h4>-->
<!--                <div style="font-size: smaller">-->
<!--                    <ul class="fa-ul">               -->
<!--                        <li>-->
<!--                            <span class="fa-li"><i class="fas fa-desktop"></i></span>-->
<!--                            <a target="_blank" href="https://alessandrolai.dev">https://alessandrolai.dev</a>-->
<!--                            <small style="vertical-align: middle">(slides & other talks here)</small>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <span class="fa-li"><i class="fas fa-envelope"></i></span>-->
<!--                            <a target="_blank" href="mailto:alessandro.lai85@gmail.com">alessandro.lai85@gmail.com</a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <span class="fa-li"><i class="fas fa-envelope"></i></span>-->
<!--                            <a target="_blank" href="mailto:alessandro.lai@facile.it">alessandro.lai@facile.it</a>-->
<!--                            <small style="vertical-align: middle">(we are hiring!)</small>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <span class="fa-li"><i class="fab fa-github"></i></span>-->
<!--                            <a target="_blank" href="https://github.com/Jean85">@Jean85</a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <span class="fa-li"><i class="fab fa-twitter"></i></span>-->
<!--                            <a target="_blank" href="https://twitter.com/AlessandroLai">@AlessandroLai</a>-->
<!--                        </li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </section>-->
        </section>
    </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [
            RevealMarkdown,
            RevealHighlight,
            RevealNotes,
            RevealZoom
        ]
    });
</script>
</body>
</html>
