<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>
		<meta name="description" content="{{ Descrizione }}">
		<meta name="author" content="Alessandro Lai">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="css/fixes.css">
		<link rel="stylesheet" href="lib/css/highlight-js/idea.css">
		<!-- FontAwesome -->
		<script defer src="lib/font/fontawesome-free-5.0.2/js/fontawesome-all.js"></script>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<img id="logo-engineering" src="img/logo_engineering.png">
			<div class="slides">
				<section id="title">
					<h2>
						Adding Event Sourcing <br>
						to an existing PHP project
					</h2>
					<h6>(for the right reasons)</h6>
					<p>
						<small>By <a href="https://github.com/Jean85">Alessandro Lai</a> / <a href="http://twitter.com/AlessandroLai">@AlessandroLai</a></small>
					</p>
					<p>
						<small><a href="https://www.meetup.com/it-IT/MilanoPHP/events/244650417/">PUG Milano</a> - January 10th 2018, Facile.it</small>
					</p>
				</section>

				<section id="intro">
					<section>
						<h2>Who am I?</h2>
						<img src="img/github_avatar.jpg" class="stretch" style="border-radius: 0.5em; margin-right: 1em; text-shadow: 0 0 6px rgba(0, 0, 0, 0.2);">
						<ul class="fa-ul" style="float: right">
							<li><span class="fa-li"><i class="fas fa-user"></i></span>Alessandro Lai</li>
							<li>
								<span class="fa-li"><i class="fab fa-github"></i></span>
								<a href="https://github.com/Jean85">@Jean85</a>
							</li>
							<li>
								<span class="fa-li"><i class="fab fa-twitter"></i></span>
								<a href="https://twitter.com/AlessandroLai">@AlessandroLai</a>
							</li>
							<li>
								<span>
									<span class="fa-li"><i class="fas fa-keyboard"></i></span>
									PHP developer @
								</span>
								<img src="img/logo_engineering_full.png" style="height: 1.6em; box-shadow: none; vertical-align: middle; margin-bottom: 0; margin-top: -0.8em">
							</li>
							<li>
								<span class="fa-li"><i class="fas fa-users"></i></span>
								PHP UG Milan Coordinator
							</li>
							<li>
								<span class="fa-li fa-layers">
									<i class="fas fa-certificate"></i>
									<i class="fas fa-xs fa-inverse fa-check"></i>
								</span>
								PHP-FIG Secretary
							</li>
						</ul>
					</section>

					<section>
						<h2>Disclaimer 1/3:</h2>
						<h3>It's a case history</h3>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-book"></i></span>
								Just a brief theory explanation
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-wrench"></i></span>
								We bent the state of the art to our use case
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-rocket"></i></span>
								Let's jump into practical implementation details!
							</li>
						</ul>
					</section>
                    
					<section class="white" data-background-image="img/shark-team.jpg">
						<h2>
							<br>
							<br>
							<br>
							Disclaimer 2/3:<br>
						</h2>
						<h2>It's a group effort!</h2>
						<h3>The Facile.it Shark team</h3>
					</section>

                    <section>
						<h2>Disclaimer 3/3:</h2>
						<img src="img/gabriele-lana.jpg" class="stretch" style="float: left; border-radius: 0.5em; margin-right: 1em; box-shadow: none;">
						<h3>We got help!</h3>
						<div>
							We reached out to <a href="https://twitter.com/gabrielelana">@gabrielelana</a>
							for a speedy bootstrap with MongoDB + Event Sourcing 
						</div>
					</section>
                </section>
				
				<section id="theory">
					<section>
						<h2>First things first:</h2>
						<p>What's Event Sourcing?</p>
					</section>
					
					<section data-background-image="img/money.jpg">
						<div class="stretch">
							<div class="credit white">https://flic.kr/p/6c6Q6r</div>
						</div>
					</section>
					
					<section>
						<h2>The prime example:</h2>
						<h3>money transactions</h3>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-edit"></i></span>
								You save only the current state (the balance)
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-wrench"></i></span>
								Each operation completely rewrites the information
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-exclamation-triangle"></i></span>
								What about concurrency???
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-exclamation-triangle"></i></span>
								We are addicted to software transactions,<br>
								but they are inherently fallible
							</li>
						</ul>
					</section>
					
					<section>
						<h2>With events, instead...</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-forward"></i></span>
								We store performed actions <br>
								<span style="font-size: smaller">(withdrawal, deposit)</span>
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-sort-numeric-down"></i></span>
								Concurrency is no longer a big issue<br>
								<span style="font-size: smaller">(negative balance)</span>
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-fast-forward"></i></span>
								Aggregating events gives me the current state<br>
								<span style="font-size: smaller">(current balance)</span>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>And CQRS?</h2>
						<p>It's a design pattern, it stands for:</p>
						<ul>
							<li><b>C</b>ommand</li>
							<li><b>Q</b>uery</li>
							<li><b>R</b>esponsibility</li>
							<li><b>S</b>egregation</li>
						</ul>
						<p>
							It's normally opposed to CRUD,<br>
							see <a href="https://martinfowler.com/bliki/CQRS.html">Martin Fowler's article</a>
						</p>
					</section>
				</section>
				
				<section id="setup">
					<section>
						<h2>Story time!</h2>
					</section>
					<section data-background-image="img/star-wars-intro.jpg">
						<div class="stretch">
							<div class="credit white">https://flic.kr/p/SuqTZG</div>
						</div>
					</section>
					<section data-background-image="img/greenfield.jpg">
						<div class="stretch">
							<div class="credit white">https://flic.kr/p/rVrVkv</div>
						</div>
					</section>
					<section data-background-image="img/legacy-project.jpg">
						<div class="stretch">
							<div class="credit white">https://flic.kr/p/VAU3d</div>
						</div>
					</section>
					<section>
						<h2>In the real world...</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-child"></i></span>
								Projects start small and simple
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-angle-double-right"></i></span>
								Especially with PHP, a fast CRUD approach <br> is used 99% of the time
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-cogs"></i></span>
								Inherent business complexity comes only with time, while adding new features
							</li>
						</ul>
					</section>
				</section>
				
				<section id="our-use-case">
					<section>
						<h2>Background</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-car"></i></span>
								Facile.it main business is comparison, <br>
								especially car insurances
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-exchange-alt"></i></span>
								We basically act as an adapter between <br>
								insurance companies and end customer
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fas fa-comment"></i></span>
								Business complexity is intermediate
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="far fa-credit-card"></i></span>
								Not so much to do after the product is sold...
							</li>
						</ul>
					</section>
					<section>
						<h2>Our use case</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-users"></i></span>
								The Shark team works on the <br>
								Facile Partner Network (FPN) project
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-handshake"></i></span>
								It's a B2B platform for car insurance brokering
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-desktop"></i></span>
								We offer the platform to insurance agents <br>
								with physical stores
							</li>
						</ul>
					</section>
					<section>
						<h2>Complexity is increased</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-reply-all"></i></span>
								We handle the product after it's sold
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-handshake"></i></span>
								We handle customer relationships
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fab fa-usb"></i></span>
								We have to be an adapter for a lot more processes
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-users"></i></span>
								Last but not least, we have a team of 40+ accounts
							</li>
						</ul>
					</section>
					<section>
						<h2>Our issues</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-chart-bar"></i></span>
								New reports are requested often
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-tasks"></i></span>
								Business rules evolve really fast!
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-history"></i></span>
								We still have to provide historical data
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-database"></i></span>
								By coincidence, we also had a small piece of functionality
								that was having growing pains inside our RDBMS (MySQL + Doctrine)
							</li>
						</ul>
					</section>
				</section>
				
				<section id="solution">
					<section>
						<h2>Our solutions</h2>
						<ol>
							<li>Gabriele</li>
							<li>MongoDB</li>
							<li>Event sourcing</li>
						</ol>
					</section>
					<section>
						<h2>Our Symfony bundle</h2>
						<ul class="fa-ul">
							<li>
								<span class="fa-li"><i class="fab fa-github"></i></span>
								<a href="https://github.com/facile-it/mongodb-bundle">
									<code>facile-it/mongodb-bundle</code>
								</a>
							</li>
							<li>
								<span class="fa-li"><i class="fa fa-database"></i></span>
								Barebone integration with <code>ext-mongodb</code>
							</li>
							<li>
								<span class="fa-li"><i class="far fa-window-maximize"></i></span>
								Nice profile addon<br>
								<img src="img/mongodb-bundle.png">
							</li>
						</ul>
					</section>
				</section>

				<section id="events-explained">
					<section>
						<h2>Events in practice</h2>
					</section>
					<section>
						<h2>Anatomy of an event</h2>
						<div>
							An event is just a document with some properties
							<br>&nbsp;
						</div>
						<ul class="fa-ul">
							<li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Type</li>
							<li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Family</li>
							<li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Payload</li>
							<li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Metadata</li>
						</ul>
					</section>
					<section>
						<pre class="stretch"><code data-trim data-noescape>{
    "_id" : ObjectId("5898ab5a22c92d69123f7281"),
    "type" : "agendaCreated",
    "eventFamily" : "agenda",
    "meta" : {
        "createdAt" : ISODate("2017-02-06T17:59:05"),
        "receivedAt" : ISODate("2017-02-06T17:59:06"),
        "currentUserId" : 29877,
        "taskId" : 3503425,
        "productId" : 5937725,
        ... 
    },
    "payload" : {
        "currentUser" : {
            "id" : 29877,
            ...
        },
        "task" : {
            "id" : 3503425,
            ...
        },
        "product" : {
            "id" : 5937725,
            ...
        }
        ...
    }
}
						</code></pre>
					</section>
					<section>
						<h2>Type & Family</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
								The type is the event name
								<div class="fragment" style="font-size: smaller">It represent the kind of document that we will have, and the structure</div>
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
								Family is a more generic grouping<br>
								(depends on business domain)
								<div class="fragment" style="font-size: smaller">
									It's helpful for searching/filtering: <br>
									you normally work with 1 or 2 families at a time
								</div>
							</li>
						</ul>
					</section>
					<section>
						<h2>The payload</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-file-alt"></i></span>
								Should contain all the data related to the event
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-history"></i></span>
								Remember, events are always in the past
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-question-circle"></i></span>
								How many things should I put in there?
								<div class="fragment">When in doubt, do not omit</div>
							</li>
						</ul>
						<p></p>
					</section>
					<section>
						<h2>Metadata</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-search"></i></span>
								We use it for search purposes
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-exclamation-triangle"></i></span>
								Indexes are a must, at least on <code>createdAt</code> 
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-list"></i></span>
								We can also use it to store system info
								<div><small>(user, origin, application...)</small></div> 
							</li>
						</ul>
					</section>
				</section>

				<section id="event-storing">
					<section>
						<h2>Storing events</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-bullhorn"></i></span>
								We already used the (Symfony) Event Dispatcher <br>
								a lot to drive our business logic
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-indent"></i></span>
								We easily identified the points where we needed to store events
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-tasks"></i></span>
								Base event + decorators 
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-leaf"></i></span>
								We didn't have enough confidence with MongoDB...
							</li>
						</ul>

					</section>
					<section>
						<h2>Real-time (delayed) storing</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-hourglass-half"></i></span>
								... so we used our (RabbitMQ) queue to delay the event storing
								and avoid failures in critical processes
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-university"></i></span>
								In theory, events should be append only, immutable and ordered in time...
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-tasks"></i></span>
								We made made this as an intentional trade-off
							</li>
						</ul>
					</section>
					<section>
						<h2>Generating events for the past</h2>
						<ul class="fa-ul">
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-history"></i></span>
								It allowed us to easily generate events for the past
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-copy"></i></span>
								We had to avoid writing duplicates
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-bug"></i></span>
								Deriving events from the current (lossy) state
							</li>
							<li class="fragment">
								<span class="fa-li"><i class="fa fa-university"></i></span>
								In theory, you shouldn't do it...
							</li>
						</ul>
						<!--<p>example: RinnovvoDiary needed +12months from event origin</p>-->
						<!--<p>What's the correct created at? You're reading current state</p>-->
					</section>
				</section>
				<section id="event-sourcing">
					<section>
						<h2>It's time to read!</h2>
					</section>
					<section>
						<h2>Projections</h2>
					</section>
					<section>
						<h2>The (one and only) runner</h2>
					</section>
					<section>
						<h2>The projection class</h2>
					</section>
					<section>
						<h2>Filtering the event stream</h2>
					</section>
					<section>
						<h2>The executors</h2>
					</section>
					<section>
						<h2>Intermediate state and correlation</h2>
						<p>example: Renewals/product selling not expected</p>
						<h2>Executors must be idempotent</h2>
						<p>Se per un bug riprocesso un evento non devo fare errori</p>
						<h2>projection state has TTL</h2>
						<p>I dati di correlazione possono scadere (es.: polizza dopo 12 mesi)</p>
						<p>Ogni executor decide come fare</p>
					</section>
					<section>
						<h2>The fulcrum: pushing state away</h2>
					</section>
				</section>
				<section id="practical-issues">
					<section>
						<h2>Practical issues</h2>
					</section>
					<section>
						<h2>Duration of a projection</h2>
						<p>stoppable projections</p>
					</section>
					<section>
						<h2>Long running processes</h2>
						<p>memory leaks (gc_clear failure)</p>
						<p>memory leaks (mongo driver)</p>
					</section>
					<section>
						<h2>Runner concurrency</h2>
						<p>NonConcurrentCommandTrait</p>
					</section>
					<section>
						<h2>Updating past events</h2>
					</section>
					<section>
						<h2>Resetting a projection</h2>
					</section>
					<section>
						<h2>Storing a copy of the projection</h2>
						<p>Production estractor (snapshot)</p>
					</section>
					<section>
						<h2>Projections and code reuse</h2>
					</section>
				</section>
				<section id="advantages">
					<section>
						<h2>What we gained</h2>
					</section>
					<section>
						<h2>Historical data without schema constraints</h2>
					</section>
					<section>
						<h2>Complex projections with low effort</h2>
					</section>
					<section>
						<h2>Intermediate results used multiple times</h2>
						<p>Production estractor bis (rete production per collaboratri & account)</p>
					</section>
					<section>
						<h2>Complexity splitted</h2>
					</section>
					<section>
						<h2>Debug superpowers</h2>
					</section>
				</section>
				<section id="ending">
					<section>
						<h2>Thanks!</h2>
					</section>
					<section>
						<h2>Contacts</h2>
					</section>
					<section>
						<h2>Questions?</h2>
					</section>
					<section>
						<h2>Attributions</h2>
					</section>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
                history: true,
                keyboard: {
                    38: 'prev', // go to the prev slide/fragment when the UP key is pressed
                    40: 'next', // go to the next slide/fragment when the DOWN key is pressed
                },
				dependencies: [
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
