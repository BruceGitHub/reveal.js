<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>PHP + ES + CQRS + DDD = ? - A planned strategy</title>
    <meta name="description" content="{{ Descrizione }}">
    <meta name="author" content="Alessandro Lai">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/facile-engineering.css" id="theme">
    <link type="image/x-icon" rel="shortcut icon" href="img/favicon.ico"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/monokai-sublime.min.css">
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section id="title" data-background-image="img/theme/bg-cover.svg">
            <h1>PHP+ES+CQRS+DDD = ?</h1>
            <h2>A planned strategy</h2>
            <p>
                <!--                <a href="https://alessandrolai.dev/">Alessandro Lai</a> / <a href="http://twitter.com/AlessandroLai">@AlessandroLai</a><br>-->
                <a href="https://gitlab.facile.it/pagamenti">Payments Team</a>
            </p>
            <small>
                <p>
                    <a href="{{ event-link }}">Venerd√¨ protetto</a> - February 18th 2022,
                    Facile.it (online)
                </p>
                <!--                <p class="smaller">-->
                <!--                    <a href="https://joind.in/talk/TODO-CHANGEME">https://joind.in/talk/TODO-CHANGEME</a>-->
                <!--                </p>-->
            </small>
        </section>

        <section id="intro">
            <section>
                <h2>Who are we?</h2>
                (TODO: team slide from Nico)
            </section>
        </section>

        <section id="section-base-concepts">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li class="current">Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>

            <section>
                <h3>Do we start from here?</h3>
                <p>Some Meet, Some requisite, Google..., Coding... </p>
                <img
                        class="r-stretch"
                        src="img/hands-coding.png"
                        width="500"
                        alt="We start from coding?"
                />
            </section>
            <section>
                <h3>No! We should start from here</h3>
                <p>We need to create a TaskForce Business & Devs</p>
                <img
                        class="r-stretch"
                        src="img/domain-and-devs_1.png"
                        alt="We start with Domains expert and Developers"
                />
            </section>
            <section>
                <h3>Well, now we start, next step?</h3>
                <p>We know the problem, how do we develop it?</p>
                <img
                        class="r-stretch"
                        src="img/which-approach.png"
                        alt="We start with Domains expert and Developers"
                />
                <p>"The context is the King" -- cit. A.Brandolini </p>
            </section>
            <section>
                <h3>Data-oriented development</h3>
                <ul>
                    <li>The data as primary asset</li>
                    <li>‚õîÔ∏è</li>
                    <ul>
                        <li>Not suitable for complex problems</li>
                        <li>Difficult to evolve</li>
                        <li>Not very expressive</li>
                        </ul>
                    <li>‚úÖ</li>
                    <ul>
                        <li>Fast</li>
                        <li>Minimal effort</li>
                        <li>Proven development mode</li>
                    </ul>
                </ul>
            </section>
            <section>
                <h3>Business-oriented development</h3>
                <p>In Pagamenti II üí∞ We have chosen this! üí™üèº</p>
                <ul>
                    <li>‚õîÔ∏è</li>
                    <ul>
                        <li>More initial effort</li>
                        <li>No suitable for simple problems</li>
                        <li>Needs discipline</li>
                    </ul>
                    <li>‚úÖ</li>
                    <ul>
                        <li>Suitable for complex problem</li>
                        <li>More expressive</li>
                        <li>More flexible</li>
                    </ul>
                </ul>
            </section>
            <section>
                <h3>Business-oriented development</h3>
                <p>We need üõ†</p>
                <p>
                    <span style="text-decoration: underline;">Nowadays</span>
                    <br>
                    <ul>
                        <li>To develop software <span style="background-color: seagreen">ready</span> to compete</li>
                        <li>in a market, increasingly elaborate and <span style="background-color: seagreen">complex</span></li>
                    </ul>
                </p>
                <hr>
                <p>
                    We need a robust mechanism that supports us int the change
                </p>
            </section>
            <section>
                <h3>The evolution of DDD - CQRS - CQRS/ES</h3>
                <p style="font-size: smaller;">To help us the tree friends: Evans, Fowler, Greg</p>
                <img
                        class="stretch"
                        src="img/timeline.jpg"
                        alt="We start with Domains expert and Developers"
                />
                <br/>
                <small>
                    <a href="https://eventmodeling.org/about/">
                        https://eventmodeling.org/about/history.jpg
                    </a>
                    -
                    with the permission of the author
                </small>
            </section>
            <section>
                <h3>Domain Driven Design</h3>
                <p style="font-size: smaller"> <span style="text-decoration: underline;">Domain Expert</span> üëâüèΩ <span style="text-decoration: underline;">Ubiquitous language</span> üëàüèΩ <span style="text-decoration: underline;">Developer</span> </p>
                <img
                        src="img/ddd.png"
                        alt="DDD simplified"
                />
            </section>

            <section>
                <h3>Domain Driven Design + CQRS </h3>
                <p><span style="text-decoration: underline;">Write</span> / <span style="text-decoration: underline;">Read</span> path | <span style="text-decoration: underline;">Commands</span> as <span style="text-decoration: underline;">Business concepts</span> </p>
                <img
                        src="img/cqrs.png"
                        alt="CQRS simplified"
                />
            </section>


            <section>
                <h3>Domain Driven Design + CQRS/ES </h3>
                <p><span style="text-decoration: underline;">Events</span> as  <span style="text-decoration: underline;">Business concepts</span> and unique <span style="text-decoration: underline;">source truth</span></p>
                <img
                        src="img/cqrs_es.png"
                        alt="CQRS/ES simplified"
                />
            </section>


            <section>
                <h3>All concepts</h3>
                <p><span style="text-decoration: underline;">Problem</span> space ‚ûû <span style="text-decoration: underline;">Solution</span> space > Delivery > üí∞</p>
                <img class="stretch" src="img/all-concepts.png" alt="All concepts"/>
            </section>
            <section>
                <h3>The goal! ‚öΩÔ∏è</h3>
                <p>New capacity to explore the Domain means <br> new opportunities for Business and Devs</p>
                <p>
                    The true and unique invariant is the Business
                    DDD / CQRS / ES
                    <br>
                    Now are ok tomorrow ? 
                </p>
                <br>
                <p>
                    In Pagamenti II we want more value <br>
                    üí∞üí∞üí∞
                    <br>
                    in the next slide, we will show how!
                </p>
            </section>

        </section>

        <section id="section-starting-point">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li class="current">Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Pagamenti 2</h3>
                <ul>
                    <p>
                        Provide a homogeneous interface for managing different payment and
                        purchasing methods
                    </p>
                    <div>   
                    <span style="float: left; width: 30%;">    
                        <p>How does it work?</p>
                    </span>
                        <span style="float: right;  width: 70%;">           
                        <img style="float: left" src="img/seq-diagram-payment.png" alt="Payment"/>
                    </span>
                    </div>
            </section>
            <section>
                <h3>Aggregate & entities involved</h3>
                <div style="margin-top: 2em;">
                    <span style="float: left; width: 50%; font-size: x-large;">
                        <div class="stretch graph">
                            <span>Product (root)</span>
                            <div>
                                <i class="fas fa-angle-down"></i> 1..n
                                <span>Orders</span>
                                <i class="fas fa-angle-down"></i> 0..n
                                <span>Payment reservations</span>
                            </div>
                        </div>
                    </span>
                    <span style="float: right;  width: 50%;">            
                        <p>                
                            <p>Are entities immutable?</p>
                            <p>What about state management?</p>
                        </p>
                    </span>
                </div>
                <aside class="notes">

                </aside>
            </section>
            <section>
                <h3>Decommissioning Sisal from api.facile.it</h3>
                <p>Why incorporate it?</p>
                <p>Opportunity of limited area of intervention</p>
            </section>
        </section>
        </section>

        <section id="section-tools">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li class="current">The tools</li>
                    <li>Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>The DDD "onion"</h3>
                <img
                        class="r-stretch"
                        src="img/ddd-onion.png"
                        width="47%"
                        alt="DDD Onion - Jeffrey Palermo"
                />
                <aside class="notes">
                    <ul>
                        <li>Al centro il domain model, qui risiede la logica sottoforma di aggregati</li>
                        <li>I servizi dell'applicazione, conoscono e interagiscono con gli aggregati per farli
                            evolvere
                        </li>
                        <li>All'esterno abbiamo la UI/interfaccia di interazione con l'applicazione, i test, che mimano
                            l'utente non conoscendo nulla dell'applicazione
                        </li>
                        <li>e infine l'infrastruttura, che √® solo uno strumento per fare cose, che il db sia un file di
                            testo o un server relazionale la logica di dominio non deve essere influenzata
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h3>Presentation: API</h3>
                <h5>Open API + Stoplight</h5>
                <img
                        style="float: left"
                        width="47%"
                        src="img/stoplight-ui.png"
                        alt="Stoplight"
                />
                <ul class="fa-ul" style="margin: 2em 1em">
                    <li>
                        <span class="fa-li"><i class="fas fa-tools"></i></span>
                        <a href="https://stoplight.io/studio/">Stoplight Studio</a>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fas fa-check-double"></i></span>
                        <a href="https://github.com/thephpleague/openapi-psr7-validator">
                            Openapi PSR7 Validator
                        </a>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fas fa-scroll"></i></span>
                        <a href="https://swagger.io/specification/" target="_blank">
                            OpenAPI 3.0 Specs
                        </a>
                    </li>
                </ul>
                <small style="display: block; clear: both">
                    Rif.
                    <a target="_blank"
                       href="https://alessandrolai.dev/talks/2021-sfday-api-contracts-openapi-during-development/">
                        API contracts: Leveraging OpenAPI during API development - A.Lai
                    </a>
                </small>
                <aside class="notes">
                    <ul>
                        <li>Come strumento per realizzare la parte di UI usiamo il design by contract (rif. slide ale
                            maggio 2021)
                        </li>
                        <li>Openapi PSR7/validator per request in ingresso anche in prod, in test testiamo le response
                            per assicurarci di deployare in accordo con il contratto
                        </li>
                        <li>Usiamo OpenAPI 3.0 perch√® siamo legati da cebe/php-openapi (1.6), ma la prossima release
                            supporter√† 3.1 (chicca sul nome del file e gitlab)
                        </li>
                        <li>Le novit√† della 3.1 includono la possibilit√† di indicare tipi multipli, permettendo di
                            esprimere il nullable
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <table>
                    <tr>
                        <td width="40%">
                            <img src="img/ddd-onion-2.png"/>
                        </td>
                        <td style="vertical-align: top; text-align: center">
                            <blockquote style="display: block; padding: 2em 1em">
                                <em>
                                    "Nothing in an inner circle can know anything at all about
                                    something in an outer circle.<br>
                                    That includes functions, classes, variables, or any other named software entity."
                                </em>
                            </blockquote>
                            <small>
                                Robert C. Martin
                            </small>
                        </td>
                    </tr>
                </table>
                <aside class="notes">
                    Rinforzare il concetto che ci√≤ che sta all'interno non conosce nulla dell'esterno, che √® un
                    utilizzatore.
                    Nel nostro progetto abbiamo quindi cominciato a creare le classiche 3 directory radice,
                    INFRASTRUCTURE/DOMAIN/APPLICATION
                    Come possiamo fare per√≤ per evitare di contaminare i diversi namespace?

                    Abbiamo bisogno di un tool che ci permetta di scrivere dei test di analisi statica per essere sicuri
                    di
                    non violare i principi del ddd.

                    Quindi affiancamo a test unitari, integrazione, funzionali, e ai test di analisi statica di php
                    dei test di analisi statica architetturale
                </aside>

            </section>
            <section>
                <aside class="notes">
                    N.B. Nota con ClassSelector che √® nostra, ma √® solo uno shortcut per il Selector.

                    N.B.B Non potremo essere cosi schizzinosi all'inizio, ma ci da una struttura.

                    MVC: Classes with name App\Model\* and classes with name App\View\* must not depend on classes with
                    name App\Controller\*
                    Inheritance: Classes with name App\Application\*Handler must extend class with name
                    App\Application\AbstractHandler
                    Composition: Classes with name App\Domain\Entity\* must implement class with name
                    App\Domain\Entity\EntityInterface

                    Layered Architecture: ensure that the inner layers do not depend on the outer ones

                    Classes with name App\Domain\* must not depend on classes with name App\Application\* and classes
                    with name App\Infrastructure\*
                </aside>
                <h3>Enforcing the "onion"</h3>
                <i class="fab fa-github"></i>
                <a href="https://github.com/carlosas/phpat">
                    PHP AT
                </a>
                <pre><code class="stretch language-php">class CoreArchitectureTest extends ArchitectureTest
{
    public function testCoreDomainDependencies(): Rule
    {
        return $this->newRule
            ->classesThat(ClassSelector::domainClasses(ClassSelector::CONTEXT_CORE))

            ->canOnlyDependOn()

            ->classesThat(ClassSelector::domainClasses(ClassSelector::CONTEXT_CORE))
            ->classesThat(Selector::haveClassName(Assert::class))
            ->classesThat(Selector::haveClassName(UuidInterface::class))

            ->build();
    }
}</code></pre>
            </section>
            <section>

                <h3>EventSauce</h3>
                <table>
                    <tr>
                        <td>
                            <a href="https://eventsauce.io/">
                                <img src="img/eventsauce.svg" alt="EventSauce logo" style="width: 4em; display: block"/>
                            </a>
                        </td>
                        <td style="vertical-align: middle">
                            <ol>
                                <li>Focused on event sourcing</li>
                                <li>Pragmatic library</li>
                                <li>Extensible by design</li>
                            </ol>
                        </td>
                    </tr>
                </table>
                <pre><code class="language-bash">composer require eventsauce/eventsauce</code></pre>
                <i class="fab fa-github"></i>
                <a href="https://github.com/eventsaucephp/eventsauce">
                    https://github.com/eventsaucephp/eventsauce
                </a>
            </section>
            <section>
                <h3>Aggregate Root ID</h3>
                <pre><code class="language-php">
namespace EventSauce\EventSourcing;

interface AggregateRootId
{
    public function toString(): string;

    public static function fromString(string $aggregateRootId): self;
}
            </code></pre>
            </section>
            <section>
                <h3>Aggregate Root ID - UUID</h3>
                <pre class="php stretch"><code class="language-php">namespace Facile\Domain\Model;
use EventSauce\EventSourcing\AggregateRootId;

abstract class AbstractAggregateRootId implements AggregateRootId
{
    private function __construct(private UuidInterface $uuid){}
    
    public static function create(): static
    {
        return new static(Uuid::uuid4());
    }
    
    public function toString(): string
    {
        return $this->uuid->toString();
    }
    
    public static function fromString(string $aggregateRootId): static
    {
        return new static(Uuid::fromString($aggregateRootId));
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root ID - Product ID</h3>
                <pre class="php"><code class="language-php">namespace Facile\Domain\Model;

final class ProductId extends AbstractAggregateRootId
{
}</code></pre>
            </section>
            <section>
                <h3>Event</h3>
                <pre class="php"><code class="language-php">namespace EventSauce\EventSourcing\Serialization;

interface SerializablePayload
{
    public function toPayload(): array;
    
    public static function fromPayload(array $payload): self;
}</code></pre>
            </section>
            <section>
                <h3>Event - Product Created (1/2)</h3>
                <pre class="stretch"><code class="language-php">
namespace Facile\Domain\Events;
                    
final class ProductCreated implements SerializablePayload
{
    private function __construct(
        private ProductId $productId,
        private \DateTimeImmutable $creationDate
    ) {
    }
    
    public static function create(ProductId $productId): self
    {
        $creationDate = new \DateTimeImmutable();
        
        return new self($productId, $creationDate);
    }

    // next slide...
}
            </code></pre>
            </section>
            <section>
                <h3>Event - Product Created (2/2)</h3>
                <pre class="php stretch"><code class="language-php">
final class ProductCreated implements SerializablePayload
{
    // ...previous slide                    

    public function toPayload(): array
    {
        return [
            'productId' => $this->productId->toString(),
            'creationDate' => $this->creationDate->format(\DATE_ATOM),
        ];
    }

    public static function fromPayload(array $payload): SerializablePayload
    {
        return new self(
            ProductId::fromString($payload['productId']),
            \DateTimeImmutable::createFromFormat(\DATE_ATOM, $payload['creationDate'])
        );
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root</h3>
                <pre><code class="php">namespace EventSauce\EventSourcing;

interface AggregateRoot
{
    public function aggregateRootId(): AggregateRootId;
    
    public function aggregateRootVersion(): int;
    
    public function releaseEvents(): array;
    
    public static function reconstituteFromEvents(
        AggregateRootId $aggregateRootId,
        Generator $events
    ): static;
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Product</h3>
                <pre><code class="language-php">namespace Facile\Domain\Model;

use EventSauce\EventSourcing\AggregateRoot;
use EventSauce\EventSourcing\AggregateRootBehaviour;

final class Product implements AggregateRoot
{
    use AggregateRootBehaviour;
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Creation</h3>
                <pre><code class="language-php">final class Product implements AggregateRoot
{
    use AggregateRootBehaviour;
    
    public static function create(ProductId $productId): self
    {
        $product = new self($productId);
        $productCreated = ProductCreated::create($productId);
        $product->recordThat($productCreated);
        
        return $product;
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Trait</h3>
                <pre class="php stretch"><code class="language-php">namespace EventSauce\EventSourcing;

trait AggregateRootBehaviour
{
    // ...
    
    private AggregateRootId $aggregateRootId;
    
    private function __construct(AggregateRootId $aggregateRootId)
    {
        $this->aggregateRootId = $aggregateRootId;
    }
    
    protected function recordThat(object $event): void
    {
        $this->apply($event);
        $this->recordedEvents[] = $event;
    }

    // ...
}
            </code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Applying events</h3>
                <pre><code class="language-php">namespace EventSauce\EventSourcing;

trait AggregateAlwaysAppliesEvents
{
    private int $aggregateRootVersion = 0;
    
    protected function apply(object $event): void
    {
        $parts = explode('\\', get_class($event));

        $this->{'apply' . end($parts)}($event);

        ++$this->aggregateRootVersion;
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Applying events</h3>
                <pre><code class="php stretch">namespace Facile\Domain\Model;

final class Product implements AggregateRoot
{
    // ...
    
    private ?\DateTimeImmutable $creationDate = null;
    
    public function applyProductCreated(ProductCreated $productCreated): void
    {
        $this->creationDate = $productCreated->getCreationDate();
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root - Reconstitution</h3>
                <pre class="php stretch"><code class="language-php">namespace EventSauce\EventSourcing;

trait AggregateRootBehaviour
{
    // ...

    public static function reconstituteFromEvents(
        AggregateRootId $aggregateRootId,
        Generator $events
    ): static
    {
        $aggregateRoot = new static($aggregateRootId);
        
        foreach ($events as $event) {
          $aggregateRoot->apply($event);
        }
        // ...
    
        return $aggregateRoot;
    }
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root Repository</h3>
                <pre class="php"><code class="language-php">namespace EventSauce\EventSourcing;

interface AggregateRootRepository
{
    public function retrieve(AggregateRootId $aggregateRootId): object;
    
    public function persist(object $aggregateRoot): void;
    
    // ...
}</code></pre>
            </section>
            <section>
                <h3>Product Repository</h3>
                <pre><code class="php">namespace Facile\Infrastructure\Repository;

use EventSauce\EventSourcing\EventSourcedAggregateRootRepository;

final class ProductRepository extends EventSourcedAggregateRootRepository
{
}</code></pre>
            </section>
            <section>
                <h3>Aggregate Root Repository (1/2)</h3>
                <pre class="php stretch"><code class="language-php">namespace EventSauce\EventSourcing;

class EventSourcedAggregateRootRepository implements AggregateRootRepository
{
    public function __construct(
        string $aggregateRootClassName,
        MessageRepository $messageRepository,
        MessageDispatcher $dispatcher = null,
        // ...
    ) {
        // ...
        $this->dispatcher = $dispatcher ?: new SynchronousMessageDispatcher();
    }

    public function retrieve(AggregateRootId $aggregateRootId): object
    {
        $className = $this->aggregateRootClassName;
        $events = $this->retrieveAllEvents($aggregateRootId);
        
        return $className::reconstituteFromEvents($aggregateRootId, $events);
    }

    // next slide...</code></pre>
            </section>
            <section>
                <h3>Aggregate Root Repository (2/2)</h3>
                <pre class="php stretch"><code class="language-php">    // ...previous slide
    public function persist(object $aggregateRoot): void
    {
        // ...
        $this->persistEvents(
            $aggregateRoot->aggregateRootId(),
            $aggregateRoot->aggregateRootVersion(),
            ...$aggregateRoot->releaseEvents()
        );
    }
    
    public function persistEvents(AggregateRootId $id, int $version, object ...$events): void
    {
        $messages = array_map(function (object $event) {
            // Events are transformed into messages
        }, $events);
        
        $this->messageRepository->persist(...$messages);
        $this->dispatcher->dispatch(...$messages);
    }
}</code></pre>
            </section>
            <section>
                <h3>Doctrine2 Message Repository</h3>
                <pre><code class="language-shell">composer require eventsauce/message-repository-for-doctrine-v2</code></pre>
                <pre><code class="language-sql">  CREATE TABLE IF NOT EXISTS `your_table_name` (

    `event_id`          BINARY(16) NOT NULL,
    `aggregate_root_id` BINARY(16) NOT NULL,
    `version`           int(20) unsigned NULL,
    `payload`           varchar(16001) NOT NULL,

    PRIMARY KEY (`event_id`),

    KEY                  (`aggregate_root_id`),
    KEY `reconstitution` (`aggregate_root_id`, `version` ASC)
  )

  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_general_ci ENGINE=InnoDB;</code></pre>
            </section>
            <section>
                <h3>Serialized Payload</h3>
                <pre class=""><code class="language-json">  {
    "headers": {
       "__aggregate_root_id": "b62a84f8-72f0-11ec-90d6-0242ac120003",
       "__aggregate_root_type": "facile.domain.model.product",
       "__aggregate_root_version": 1,
       "__event_type": "facile.domain.events.product_created",
       "__time_of_recording": "2022-02-08 09:44:36.407236+0000",
       "__aggregate_root_id_type": "facile.domain.model.product_id",
       "__event_id": "24b38b08-9042-4035-bbff-6bd75295e1b9"
    },
    "payload": {
       "productId": "b62a84f8-72f0-11ec-90d6-0242ac120003",
       "creationDate": "2022-02-08T10:44:36+01:00"
    }
  }</code></pre>
            </section>
            <section>
                <h3>EventSauce Lifecycle</h3>
                <pre><code class="language-php">
    $product = $productRepository->retrieve($aggregateRootId);
    
    $product->addOrder($command);
    
    $productRepository->persist($product);
            </code></pre>
            </section>
            <section>
                <h3>EventSauce Lifecycle</h3>
                <pre class="php stretch"><code class="language-php">namespace Facile\Domain\Model;

class Product implements AggregateRoot
{
    // ...

    public function addOrder(AddOrderCommand $command): void
    {
        if (null !== $this->order) {
            throw new \DomainException('Order already present');
        }
        
        $orderAdded = OrderAdded::create($command);
        $this->recordThat($orderAdded);
    }

    public function applyOrderAdded(OrderAdded $orderAdded): void
    {
        $this->order = new Order($orderAdded->getOrderId(), $orderAdded->getMoney());
    }
}</code></pre>
            </section>
            <section>
                <h3>EventSauce Lifecycle</h3>
                <pre class=""><code class="language-php">use EventSauce\EventSourcing\MessageConsumer;

class OrdersReadModel implements MessageConsumer
{
    public function handle(Message $message)
    {
        $aggregateRootId = $message->aggregateRootId();
        $event = $message->event();
    
        if ($event instanceof OrderAdded){
            # Instantiates a custom entity and persist it
        }
    }
}</code></pre>
            </section>
        </section>

        <section id="section-migration-strategy">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li class="current">Our migration strategy</li>
                    <li>Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Green field vs running project</h3>
                All this is great for a new project...<br>
                <div class="fragment">
                    ...but what can we do in a running project?
                    <img src="img/changing_wheels.webp"/>
                </div>
            </section>
            <section>
                <h3>Root-first or Leaf first?</h3>
                <div class="stretch graph">
                    <span class="fragment" data-fragment-index="2">Product (root)</span>
                    <div class="fragment" data-fragment-index="3">
                        <i class="fas fa-angle-down"></i> 1..n
                        <span>Orders</span>
                        <i class="fas fa-angle-down"></i> 0..n
                        <span>Payment reservations</span>
                        <i class="fas fa-angle-down"></i> 0..1
                    </div>
                    <span class="fragment" data-fragment-index="1">Mooney codes</span>
                </div>
                <aside class="notes">
                    <ol>
                        <li>incomplete event picture</li>
                        <li>leaf first: no aggregate root id</li>
                        <li>root first: hole in the middle</li>
                    </ol>
                </aside>
            </section>
            <section>
                <h3>The breakthrough</h3>
                <img src="img/multiple-sources-of-lies.jpeg" class="stretch"/>
                <br>
                <small>
                    "You have a single source of truth,
                    or multiple sources of lies"
                </small>
            </section>
            <section>
                <h3>The great workshop take-away</h3>
                <table>
                    <tr>
                        <td style="text-align: center; vertical-align: top">
                            <img src="img/marco.png" alt="Marco Heimeshoff"/>
                            <br>
                            <i class="fab fa-twitter"></i>
                            <a href="https://twitter.com/Heimeshoff">
                                @Heimeshoff
                            </a>
                            <br><br>
                            <small>
                            </small>
                        </td>
                        <td>
                            <ul class="fa-ul" style="margin-top: 1em">
                                <li style="margin-bottom: 1em">
                                    <span class="fa-li"><i class="fas fa-chalkboard-teacher"></i></span>
                                    <a href="https://www.avanscoperta.it/it/training/domain-models-in-practice-ddd-cqrs-event-sourcing/">
                                        Domain Models in practice:<br>
                                        DDD, CQRS & Event Sourcing
                                    </a>
                                </li>
                                <li class="fragment">
                                    <span class="fa-li"><i class="fas fa-database"></i></span>
                                    DB transactions to save data atomically
                                </li>
                                <li class="fragment">
                                    <span class="fa-li"><i class="fas fa-sync"></i></span>
                                    Sync between legacy tables and event store
                                </li>
                                <li class="fragment">
                                    <span class="fa-li"><i class="fas fa-clock"></i></span>
                                    Migrating will take a LONG time
                                </li>
                            </ul>
                        </td>
                    </tr>
                </table>
            </section>
            <section>
                <h3>Generating events on-the-fly</h3>
                <pre class="stretch">
<code class="language-php">
class ProductRepository 
    extends EventSourcedAggregateRootRepository 
    implements ProductRepositoryInterface
{
    public function retrieve(AggregateRootId $id): object
    {
        $product = parent::retrieve($id);

        if ($product === null) {
            $doctrineProduct = $this->doctrineRepository->find($id);

            $product = Product::reconstituteFromEvents(
                $this->eventGenerator->generateFrom($doctrineProduct)
            );
        }

        return $product;
    }
}</code></pre>
            </section>
            <section>
                <h3>Maintain the Doctrine tables (1/2)</h3>
                <pre class="stretch">
<code class="language-php">final class Prodotto implements AggregateRoot
{
    // ...

    public function reservePayment(ReservePayment $command): void
    {
        if (/* ... */) {
            // domain logic & validation...
        }

        $event = new MooneyCodeCreated(/* ... */);

        // add the event to the aggregate
        $this->recordThat($event);

        // register the same stuff in the Doctrine entity
        $this->getDoctrineProduct()->addNewCode($event)
    }

    // ...
}</code></pre>
            </section>
            <section>
                <h3>Maintain the Doctrine tables (2/2)</h3>
                <pre class="stretch">
<code class="language-php">class ReservePaymentHandler implements MessageHandlerInterface
{
    public function __invoke(ReservePayment $command): void
    {
        $id = $command->getRootId();
        // retrieve both the aggregate and the Doctrine entity
        $product = $this->productRepository->retrieve($id);

        // invoke the domain logic
        $product->reservePayment($command);

        // atomic flush due to single DB connection
        $this->doctrineRepository->beginTransaction();

        $this->productRepository->persist($product);
        $this->doctrineRepository->flush();

        $this->doctrineRepository->commit();
    }
}</code></pre>
            </section>
            <section>
                <h3>How to iterate</h3>
                <pre class="php stretch">
<code class="language-php">class ProductRepository 
    extends EventSourcedAggregateRootRepository 
    implements ProductRepositoryInterface
{
    public function retrieve(AggregateRootId $id): object
    {
        $product = parent::retrieve($id);
    
        if ($this->eventsAreOutdated($product)) {
            $this->purgeEvents($id);
            $product = null;
        }

        if ($product === null) {
            // ...
        }

        return $product;
    }
    // ...
}</code></pre>
            </section>
        </section>
        <section id="section-conclusions">
            <section style="text-align: left">
                <ol class="sections-list">
                    <li>Base concepts</li>
                    <li>Our starting point</li>
                    <li>The tools</li>
                    <li>Our migration strategy</li>
                    <li class="current">Conclusions</li>
                </ol>
            </section>
            <section>
                <h3>Advantages</h3>
                <ul class="fa-ul">
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-shipping-fast"></i></span>
                        Fast iterations
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-user-ninja"></i></span>
                        Gain confidence iteratively
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-cogs"></i></span>
                        Leverage ES & DDD immediately
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-database"></i></span>
                        Doctrine still works
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-hourglass-half"></i></span>
                        No fixed deadlines
                    </li>
                    <li class="fragment">
                        <span class="fa-li"><i class="fas fa-user-tie"></i></span>
                        Still deliver business value
                    </li>
                </ul>
            </section>
            <section>
                <h3>Disadvantages / pitfalls</h3>
                <ol>
                    <li>It may take a long time</li>
                    <li class="fragment">...can you tell us more?</li>
                </ol>
                <br>
                <br>
                <br>
                <h1 class="fragment">Questions?</h1>
            </section>
            <section>
                <h2>Thanks!</h2>
                <!--                <p>-->
                <!--                    Please rate my talk on Joind.in: <a href="https://joind.in/talk/TODO-CHANGEME">https://joind.in/talk/TODO-CHANGEME</a>-->
                <!--                </p>-->
                <!--                <img class="stretch" src="img/joindin-qr.png" alt="Joind.in link: https://joind.in/talk/TODO-CHANGEME">-->
            </section>
            <!--            <section>-->
            <!--                <h2 style="margin-bottom: 2em">Questions?</h2>-->
            <!--                <h4>Contacts</h4>-->
            <!--                <div style="font-size: smaller">-->
            <!--                    <ul class="fa-ul">               -->
            <!--                        <li>-->
            <!--                            <span class="fa-li"><i class="fas fa-desktop"></i></span>-->
            <!--                            <a target="_blank" href="https://alessandrolai.dev">https://alessandrolai.dev</a>-->
            <!--                            <small style="vertical-align: middle">(slides & other talks here)</small>-->
            <!--                        </li>-->
            <!--                        <li>-->
            <!--                            <span class="fa-li"><i class="fas fa-envelope"></i></span>-->
            <!--                            <a target="_blank" href="mailto:alessandro.lai85@gmail.com">alessandro.lai85@gmail.com</a>-->
            <!--                        </li>-->
            <!--                        <li>-->
            <!--                            <span class="fa-li"><i class="fas fa-envelope"></i></span>-->
            <!--                            <a target="_blank" href="mailto:alessandro.lai@facile.it">alessandro.lai@facile.it</a>-->
            <!--                            <small style="vertical-align: middle">(we are hiring!)</small>-->
            <!--                        </li>-->
            <!--                        <li>-->
            <!--                            <span class="fa-li"><i class="fab fa-github"></i></span>-->
            <!--                            <a target="_blank" href="https://github.com/Jean85">@Jean85</a>-->
            <!--                        </li>-->
            <!--                        <li>-->
            <!--                            <span class="fa-li"><i class="fab fa-twitter"></i></span>-->
            <!--                            <a target="_blank" href="https://twitter.com/AlessandroLai">@AlessandroLai</a>-->
            <!--                        </li>-->
            <!--                    </ul>-->
            <!--                </div>-->
            <!--            </section>-->
        </section>
    </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        width: 1280,
        height: 720,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [
            RevealMarkdown,
            RevealNotes,
            RevealZoom
        ]
    });
</script>
</body>
</html>
